{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI-Assisted Programming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Prism CSS for code highlighting (optional) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"/>
    <style>
        /* Set full viewport height */
        html, body {
            height: 100vh;
            margin: 0;
        }

        /* Main content takes up 75% of viewport height */
        .main-content {
            height: 75vh;
        }

        /* General Styles */
        body {
            background-color: #121212;
            color: #e0e0e0;
        }

        /* Editor container styling */
        #editor-container {
            height: 100%;
            width: 100%;
            background-color: #1e1e1e;
            overflow: hidden;
        }

        .monaco-editor {
            width: 100% !important;
            height: 100% !important;
            box-sizing: border-box;
            margin: 0;
        }

        #chat-body {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }

        ul {
            margin: 0.5em 1em;
            padding-left: 1.5em;
            list-style-type: disc;
        }

        /* Custom styling for compiler errors */
        .compiler-error {
            color: red;
            font-family: Consolas, Monaco, monospace;
            white-space: pre-wrap;
            background-color: #2b2b2b;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">AI-Assisted Programming</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <div class="me-auto">
                <button class="btn btn-outline-secondary" id="select-language-button">
                    Current Language: Java
                </button>
            </div>
            <!-- Pills for Compiler and AI Tool -->
            <ul class="nav nav-pills me-auto">
                <li class="nav-item">
                    <button class="nav-link active" id="pills-compiler-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-compiler" type="button" role="tab">Compiler
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="pills-ai-tool-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-ai-tool" type="button" role="tab">AI Tool
                    </button>
                </li>
            </ul>
            <!-- Display current question number and score -->
            <div class="d-flex align-items-center me-3">
                <span class="badge bg-secondary">
                    Question: {{ question_number }} of {{ total_questions }}
                </span>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">
                    Score: {{ score }}
                </span>
                {% if user.is_authenticated %}
                    <a href="{% url 'logout' %}" class="btn btn-danger btn-sm mx-2">Logout</a>
                {% endif %}
                <button type="button" class="btn btn-success btn-sm mx-2" id="run-code-button">Run Code</button>
                <!-- Submit Code Form: normal submission that reloads the page -->
                <form id="codeForm" method="POST" action="{% url 'submit-code' %}" class="d-inline"
                      onsubmit="return confirm('By pressing this button, you will move onto the next question and submit your answer. Are you sure?');">
                    {% csrf_token %}
                    <input type="hidden" name="code" id="hiddenCodeInput">
                    <button type="submit" class="btn btn-danger btn-sm">Submit</button>
                </form>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid main-content py-3">
    <div class="row g-3 h-100">
        <!-- Code Editor Card -->
        <div class="col-12 col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-secondary text-white">Code Editor</div>
                <div class="card-body p-0" id="editor-container">
                    <!-- Monaco Editor will load here -->
                </div>
            </div>
        </div>
        <!-- Compiler Output & AI Tool Card -->
        <div class="col-12 col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">
                    Compiler Output & AI Tool
                </div>
                <div class="card-body">
                    <div class="tab-content" id="pills-tabContent">
                        <!-- Compiler Tab Content -->
                        <div class="tab-pane fade show active" id="pills-compiler" role="tabpanel"
                             aria-labelledby="pills-compiler-tab">
                            <h5>Question:</h5>
                            <p id="question-text">{{ question.question_string }}</p>
                            <div id="compiler-output" class="border rounded p-3 bg-light text-dark"
                                 style="height: 150px; overflow-y: auto;">
                                Actual output will appear here...
                            </div>
                            <h5 class="mt-3">Comparison</h5>
                            <div id="comparison" class="border rounded p-3 bg-light text-dark"
                                 style="height: 150px; overflow-y: auto;">
                                Comparison results will appear here...
                            </div>
                        </div>
                        <!-- AI Tool Tab Content -->
                        <div class="tab-pane fade" id="pills-ai-tool" role="tabpanel"
                             aria-labelledby="pills-ai-tool-tab">
                            <div class="card">
                                <div class="card-header bg-primary text-white">AI Chatbot</div>
                                <div class="card-body" id="chat-body">
                                    <!-- Chat messages will be appended here -->
                                </div>
                                <div class="card-footer">
                                    <div class="input-group">
                                        <input type="text" id="user-input" class="form-control"
                                               placeholder="Type a message...">
                                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End tab-content -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prism CSS and JS for code highlighting in AI responses -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>

<!-- Diff Match Patch Library (if used) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/google-diff-match-patch/20121119/diff_match_patch.js"></script>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<!-- Monaco Editor Loader -->
<script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
        crossorigin="anonymous"></script>
<!-- Google Generative AI (using an ES module CDN) -->
<script type="module">
    import {GoogleGenerativeAI} from "https://esm.run/@google/generative-ai";

    const apiKey = "AIzaSyBMydRJXTiK2UGG0QhwSo8KMlv5mt8IFLg";
    window.genAI = new GoogleGenerativeAI(apiKey);
</script>
<!-- External JavaScript files -->
<script src="{% static 'js/javaCompletions.js' %}"></script>
<script src="{% static 'js/manualDiagnostics.js' %}"></script>

<!-- Run Code Button functionality (AJAX for testing code) -->
<script type="text/javascript">
    document.getElementById("run-code-button").addEventListener("click", async function () {
        const compilerOutput = document.getElementById("compiler-output");
        const comparisonContainer = document.getElementById("comparison");
        const editorContent = window.editor.getValue();

        clearPreviousOutput(compilerOutput, comparisonContainer);

        if (!editorContent.includes("class Main")) {
            displayError(compilerOutput, "Error: Your code must be inside a class named 'Main'.");
            return;
        }

        let typingInterval = displayTypingIndicator(compilerOutput);

        try {
            const data = await sendCodeToServer(editorContent);
            clearInterval(typingInterval);
            processServerResponse(data, compilerOutput, comparisonContainer);
        } catch (error) {
            clearInterval(typingInterval);
            console.error("Error:", error);
            displayError(compilerOutput, "An error occurred while running your code.");
        }
    });

    function clearPreviousOutput(compilerOutput, comparisonContainer) {
        compilerOutput.innerHTML = "";
        comparisonContainer.innerHTML = "";
    }

    function displayError(container, message) {
        container.innerHTML = `<pre class="compiler-error">${message}</pre>`;
    }

    function displayTypingIndicator(container) {
        let dots = "";
        return setInterval(() => {
            dots = dots.length < 3 ? dots + "." : "";
            container.innerText = "Compiling" + dots;
        }, 500);
    }

    async function sendCodeToServer(code) {
        const response = await fetch("/run-code/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: new URLSearchParams({code}),
        });
        return response.json();
    }

    function processServerResponse(data, compilerOutput, comparisonContainer) {
        if (data.error) {
            displayError(compilerOutput, data.error);
            return;
        }

        let outputHtml = "<h5>Program Output:</h5><ul>";
        let comparisonHtml = "<h5>Comparison Results:</h5>";

        data.results.forEach((result, idx) => {
            outputHtml += `<li><strong>Test ${idx + 1}:</strong> ${result.actual_output.trim()}</li>`;

            let diffHtml = highlightDifferences(result.expected_output.trim(), result.actual_output.trim());
            let testPassed = result.expected_output.trim() === result.actual_output.trim()
                ? `<span style="color: green;">✔ Passed</span>`
                : `<span style="color: red;">❌ Failed</span>`;

            comparisonHtml += `
            <h6>Test Case ${idx + 1}:</h6>
            <strong>Input:</strong> ${result.input ? result.input.trim() : "N/A"}<br>
            <strong>Expected Output:</strong> ${result.expected_output.trim()}<br>
            <strong>Actual Output:</strong> ${diffHtml}<br>
            <strong>Result:</strong> ${testPassed}
            <hr>`;
        });

        outputHtml += "</ul>";
        compilerOutput.innerHTML = outputHtml;
        comparisonContainer.innerHTML = comparisonHtml;
    }

    function highlightDifferences(expected, actual) {
        let highlighted = "";
        for (let i = 0; i < Math.max(expected.length, actual.length); i++) {
            highlighted += expected[i] === actual[i]
                ? `<span style="color:green;">${actual[i] || ""}</span>`
                : `<span style="color:red;">${actual[i] || ""}</span>`;
        }
        return highlighted;
    }

    // Save code in hidden input before form submission
    document.getElementById("codeForm").addEventListener("submit", function () {
        document.getElementById("hiddenCodeInput").value = window.editor.getValue();
    });


    // Code Form Submission for saving code (normal submission that reloads the page)
    document.getElementById("codeForm").addEventListener("submit", function () {
        var code = editor.getValue();
        document.getElementById("hiddenCodeInput").value = code;
    });
</script>

<!-- Helper function for AI responses (formatting code blocks, bullet lists, numbered lists, etc.) -->
<script type="text/javascript">
    function formatAIResponse(text) {
        return text.replace(/```java([\s\S]*?)```/g, (_, code) =>
            `<pre><code class="language-java">${code.trim()}</code></pre>`
        ).split("\n").map(line => processListFormatting(line)).join("\n");
    }

    function processListFormatting(line) {
        if (/^\s*([-*+])\s+/.test(line)) return wrapInList(line, "ul");
        if (/^\s*\d+\.\s+/.test(line)) return wrapInList(line, "ol");
        return line;
    }

    function wrapInList(line, type) {
        let content = line.replace(/^\s*([-*+]|\d+\.)\s+/, "");
        return `<${type}><li>${content}</li></${type}>`;
    }

    let editor;
    setupMonacoEditor();

    function setupMonacoEditor() {
        require.config({paths: {'vs': 'https://unpkg.com/monaco-editor@latest/min/vs'}});

        window.MonacoEnvironment = {getWorkerUrl: () => proxy};
        let proxy = URL.createObjectURL(new Blob([`
        self.MonacoEnvironment = { baseUrl: 'https://unpkg.com/monaco-editor@latest/min/' };
        importScripts('https://unpkg.com/monaco-editor@latest/min/vs/base/worker/workerMain.js');
    `], {type: 'text/javascript'}));

        require(["vs/editor/editor.main"], function () {
            window.editor = monaco.editor.create(document.getElementById("editor-container"), {
                value: `{{ user_starter_code|escapejs }}`,
                language: "java",
                theme: "vs-dark"
            });
            if (typeof registerJavaCompletions === "function") {
                registerJavaCompletions();
            }
        });
    }
</script>

<!-- AI Chatbot functionality -->
<script type="text/javascript">
    document.getElementById("user-input").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        let userInput = document.getElementById("user-input").value.trim();
        if (!userInput) return;

        addUserMessage(userInput);
        document.getElementById("user-input").value = "";
        let botMessage = addBotMessage("Typing...");

        let typingInterval = displayTypingIndicator(botMessage);

        try {
            const aiResponse = await getAIResponse(userInput);
            clearInterval(typingInterval);
            botMessage.innerHTML = formatAIResponse(aiResponse);
            Prism.highlightAll();
        } catch (error) {
            clearInterval(typingInterval);
            botMessage.innerText = "Error fetching response. Please try again.";
            console.error("Error:", error);
        }

        scrollToBottom("chat-body");
    }

    function addUserMessage(message) {
        let chatBody = document.getElementById("chat-body");
        let userMessage = createMessageElement("chat-message bg-primary text-white rounded p-2 mb-2 text-end", message);
        chatBody.appendChild(userMessage);
    }

    function addBotMessage(initialText) {
        let chatBody = document.getElementById("chat-body");
        let botMessage = createMessageElement("chat-message bg-secondary text-light rounded p-2 mb-2 text-start", initialText);
        chatBody.appendChild(botMessage);
        return botMessage;
    }

    function createMessageElement(className, text) {
        let messageElement = document.createElement("div");
        messageElement.className = className;
        messageElement.innerText = text;
        return messageElement;
    }

    function displayTypingIndicator(container) {
        let dots = "";
        return setInterval(() => {
            dots = dots.length < 3 ? dots + "." : "";
            container.innerText = "Typing" + dots;
        }, 500);
    }

    async function getAIResponse(userInput) {
        const model = genAI.getGenerativeModel({model: "gemini-2.0-flash"});
        const result = await model.generateContent(userInput);
        return result.response.text();
    }

    function scrollToBottom(containerId) {
        let chatBody = document.getElementById(containerId);
        chatBody.scrollTop = chatBody.scrollHeight;
    }
</script>

<!-- Initialize Manual Diagnostics -->
<script src="{% static 'js/manualDiagnostics.js' %}"></script>
<script>
    window.initManualDiagnostics();
</script>
</body>
</html>
