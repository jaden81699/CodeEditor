{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create or Edit Questions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }

        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }

        .formset-row {
            margin-bottom: 1rem;
        }

        .error-message {
            color: red;
            font-size: 0.875rem;
            margin-top: 5px;
        }

        /* Styling for Output & Comparison Containers */
        #output-container, #comparison-container {
            display: none;
            background-color: #222;
            color: #0f0;
        !important;
            border: 1px solid #444;
            padding: 10px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        #comparison-container {
            color: white;
        }

        /* Highlighting styles */
        .correct {
            color: green;
            font-weight: bold;
        }

        .incorrect {
            color: red;
            font-weight: bold;
        }

        /* Monaco Editor Styling */
        #userStarterEditor, #instructorEditor {
            height: 200px;
            border: 1px solid #ccc;
        }

    </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">AI-Assisted Programming</a>
    </div>
</nav>

<!-- Main Content -->
<div class="container my-4">
    <h1 class="mb-4">Manage Questions</h1>
    <div class="card mb-4">
        <div class="card-header">
            {% if question %}Edit Question{% else %}Add New Question{% endif %}
        </div>
        <div class="card-body">
            <form method="post" id="question-form">
                {% csrf_token %}

                <!-- Hidden Input for Question ID -->
                <input type="hidden" name="question_id" id="question_id" value="{{ question.id }}">


                <!-- Render Question Form -->
                <div class="mb-3">
                    {{ q_form.question_string.label_tag }}
                    {{ q_form.question_string }}
                    <div id="question_string_error" class="error-message"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Question Type</label>
                    {% for radio in q_form.question_type %}
                        <div class="form-check">
                            {{ radio.tag }}
                            <label class="form-check-label" for="{{ radio.id_for_label }}">
                                {{ radio.choice_label }}
                            </label>
                        </div>
                    {% endfor %}
                    <div id="question_type_error" class="error-message"></div>
                </div>

                <!-- Code Editors -->
                <div class="mb-3">
                    <h5>User Starter Code</h5>
                    <div id="userStarterEditor" style="height: 200px; border: 1px solid #ccc;"></div>
                    <input type="hidden" name="user_starter_code" id="id_user_starter_code"
                           value="{{ q_form.user_starter_code.value|default:'' }}">
                    <div id="user_starter_code_error" class="error-message"></div>

                    <h5>Instructor Code</h5>
                    <div id="instructorEditor" style="height: 200px; border: 1px solid #ccc;"></div>
                    <input type="hidden" name="instructor_code" id="id_instructor_code"
                           value="{{ q_form.instructor_code.value|default:'' }}">
                    <div id="instructor_code_error" class="error-message"></div>
                </div>

                <!-- Output Container -->
                <h5>Output</h5>
                <div id="output-container"></div>

                <!-- Comparison Container -->
                <h5>Comparison</h5>
                <div id="comparison-container"></div>

                <button type="button" id="run-code-button" class="btn btn-success mt-2">Run Code</button>

                <!-- Test Cases Formset -->
                <h4 class="mt-4">Test Cases</h4>
                <div id="formset-container">
                    {{ formset.management_form }}
                    {% for form in formset %}
                        <div class="test-case-form border p-3">
                            {{ form.as_p }}
                            {% if form.instance.pk %}
                                <div class="form-check">
                                    {{ form.DELETE }}
                                    <label class="form-check-label" for="{{ form.prefix }}-DELETE">Delete</label>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-test-case" class="btn btn-secondary mb-3">Add Test Case</button>
                <br>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>

    <!-- Existing Questions Table -->
    <h2 class="mt-4">Existing Questions</h2>
    <table class="table table-dark table-bordered">
        <thead>
        <tr>
            <th>ID</th>
            <th>Question</th>
            <th>Type</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for question in questions %}
            <tr>
                <td>{{ question.id }}</td>
                <td>{{ question.question_string }}</td>
                <td>{{ question.get_question_type_display }}</td>
                <td>
                    <a href="{% url 'create-or-edit-questions' question.id %}" class="btn btn-warning btn-sm">Edit</a>
                    <a href="#" class="btn btn-danger btn-sm">Delete</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- jQuery and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        require.config({
            paths: {vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs'}
        });
        require(['vs/editor/editor.main'], function () {
            const userEditor = monaco.editor.create(
                document.getElementById('userStarterEditor'),
                {
                    value: document.getElementById('id_user_starter_code').value || '',
                    language: 'java',
                    theme: 'vs-dark',
                    automaticLayout: true
                }
            );
            const instructorEditor = monaco.editor.create(
                document.getElementById('instructorEditor'),
                {
                    value: document.getElementById('id_instructor_code').value || '',
                    language: 'java',
                    theme: 'vs-dark',
                    automaticLayout: true
                }
            );

            // keep form inputs in sync
            userEditor.onDidChangeModelContent(() => {
                document.getElementById('id_user_starter_code').value = userEditor.getValue();
            });
            instructorEditor.onDidChangeModelContent(() => {
                document.getElementById('id_instructor_code').value = instructorEditor.getValue();
            });

            // Run Code button
            $('#run-code-button').on('click', function () {
                const code = instructorEditor.getValue().trim();
                const questionId = $('#question_id').val();
                if (!code) {
                    alert('Please enter some code before running.');
                    return;
                }

                showRunning();
                $.ajax({
                    url: "{% url 'run-code' %}",
                    type: 'POST',
                    data: {
                        code: code,
                        question_id: questionId,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: handleRunCodeSuccess,
                    error: handleRunCodeError
                });
            });

            function showRunning() {
                $('#output-container')
                    .show()
                    .text('Compilingâ€¦');
                $('#comparison-container').hide().empty();
            }

            function handleRunCodeSuccess(data) {
                if (data.error) {
                    return $('#output-container')
                        .show()
                        .css('color', 'red')
                        .text('Error: ' + data.error);
                }

                // build output list, guarding .trim():
                const outputHtml = [
                    '<h5>Program Output:</h5><ul>',
                    ...data.results.map((r, i) => {
                        const actual = (r.actual_output || '').trim();
                        return `<li><strong>Test ${i + 1}:</strong> ${escapeHtml(actual)}</li>`;
                    }),
                    '</ul>'
                ].join('');

                // build comparison, also guarding trim()
                const comparisonHtml = [
                    '<h5>Comparison Results:</h5>',
                    ...data.results.map((r, i) => {
                        const exp = (r.expected_output || '').trim();
                        const act = (r.actual_output || '').trim();
                        const inp = (r.input || '').trim();  // safe even if undefined
                        const passed = r.passed;
                        const diff = passed
                            ? `<span class="correct">${escapeHtml(act)}</span>`
                            : highlightDiff(exp, act);

                        return `
        <h6>Test Case ${i + 1}:</h6>
        ${inp
                            ? `<strong>Input:</strong> ${escapeHtml(inp)}<br>`
                            : ''
                        }
        <strong>Expected:</strong> ${escapeHtml(exp)}<br>
        <strong>Actual:</strong> ${diff}<br>
        <strong>Result:</strong>
          ${passed
                            ? '<span class="correct">âœ” Passed</span>'
                            : '<span class="incorrect">âœ˜ Failed</span>'}
        <hr>
      `;
                    })
                ].join('');

                $('#output-container')
                    .html(outputHtml).show();
                $('#comparison-container').html(comparisonHtml).show();
            }

            function handleRunCodeError(xhr, status, error) {
                $('#output-container')
                    .show()
                    .css('color', 'red')
                    .text('An error occurred while running your code.');
                console.error('Runâ€‘code AJAX error:', status, error);
            }

            function highlightDiff(expected, actual) {
                let out = '';
                const length = Math.max(expected.length, actual.length);
                for (let i = 0; i < length; i++) {
                    const e = expected[i] || '';
                    const a = actual[i] || '';
                    const cls = (e === a) ? 'green' : 'red';
                    out += `<span style="color:${cls};">${escapeHtml(a)}</span>`;
                }
                return out;
            }

            // simple HTML escape to avoid injection
            function escapeHtml(s) {
                return s
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }
        });
    });
</script>


</body>
</html>
