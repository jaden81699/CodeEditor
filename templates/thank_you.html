{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Thank You — AI-Assisted Programming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        /* App-wide dark theme */
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --card-2: #2b2b2b;
            --text: #e0e0e0;
            --muted: #a0a0a0;
            --brand: #0d6efd; /* Bootstrap primary */
            --good: #3ddc97;
        }

        html, body {
            height: 100%;
        }

        body {
            background: var(--bg);
            color: var(--text);
        }

        .navbar-dark.bg-dark {
            background-color: #0f0f0f !important;
        }

        /* Card styling consistent with your app */
        .card {
            background: var(--card);
            border: 1px solid #2a2a2a;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }

        .card-header {
            background: linear-gradient(180deg, #1f3d63, #1a2f4a);
            border-bottom: 1px solid #243447;
            color: #fff;
        }

        .lead {
            color: #cfd8dc;
        }

        /* Animated success mark */
        .success-mark {
            width: 84px;
            height: 84px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            margin: 0 auto 0.75rem auto;
            background: radial-gradient(120px 120px at 50% 50%, rgba(61, 220, 151, .15), rgba(61, 220, 151, 0));
            border: 2px solid rgba(61, 220, 151, .6);
            box-shadow: 0 0 24px rgba(61, 220, 151, .35) inset, 0 0 24px rgba(61, 220, 151, .2);
            position: relative;
            animation: pulse 2s ease-in-out infinite;
        }

        .success-mark::after {
            content: "";
            width: 34px;
            height: 18px;
            border: 4px solid var(--good);
            border-top: 0;
            border-left: 0;
            transform: rotate(-45deg) scaleX(-1); /* ← horizontal flip */
            transform-origin: center; /* keep the flip centered */
            position: relative;
            top: -2px;
            filter: drop-shadow(0 0 6px rgba(61, 220, 151, .6));
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Confetti (subtle) */
        .confetti {
            pointer-events: none;
            position: fixed;
            inset: 0;
            overflow: hidden;
            z-index: 0;
        }

        .confetti i {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #6cf;
            opacity: .7;
            top: -10px;
            border-radius: 1px;
            animation: confetti-fall linear forwards;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(110vh) rotate(540deg);
                opacity: .9;
            }
        }

        /* Completion code input */
        .code-box input {
            background: #111;
            color: #fff;
            border: 1px solid #333;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            letter-spacing: .5px;
        }

        .text-muted {
            color: var(--muted) !important;
        }
    </style>
</head>
<body>
<!-- Navbar (matches your app) -->
<nav class="navbar sticky-top navbar-expand-md navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">AI-Assisted Programming</a>
    </div>
</nav>

<!-- Subtle confetti -->
<div class="confetti" aria-hidden="true" id="confetti"></div>

<!-- Main -->
<main class="container d-flex align-items-center justify-content-center" style="min-height: calc(100vh - 56px);">
    <div class="row justify-content-center w-100">
        <div class="col-12 col-md-10 col-lg-8 col-xxl-7">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Thank you for participating</h5>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-3">
                        <div class="success-mark"></div>
                        <h2 class="fw-semibold mb-1 text-dark-emphasis">You’re all set!</h2>
                        <p class="lead mb-0">Your surveys and coding submissions have been recorded.</p>
                    </div>

                    <!-- Completion code (optional) -->
                    {% if completion_code %}
                        <div class="mt-4">
                            <label class="form-label">Completion Code</label>
                            <div class="input-group code-box">
                                <input id="completionCode" type="text" class="form-control"
                                       value="{{ completion_code }}" readonly>
                                <button id="copyBtn" class="btn btn-outline-light" type="button">Copy</button>
                            </div>
                            <div id="copyHint" class="form-text text-muted">Provide this code if you were asked to
                                confirm participation.
                            </div>
                        </div>
                    {% endif %}

                    <!-- What happens next -->
                    <div class="mt-4">
                        <h6 class="text-uppercase text-muted small mb-2">What happens next</h6>
                        <ul class="mb-0 text-muted">
                            <li>Your data are saved securely. You may close this tab or log out below.</li>
                            <li>If you have questions or want to withdraw your data, contact us at
                                <a href="mailto:{{ support_email|default:'research@example.edu' }}" class="link-info">
                                    {{ support_email|default:'research@example.edu' }}
                                </a>
                            </li>
                            <li class="text-muted">IRB/Study info: <span
                                    class="text-muted">{{ study_title|default:"AI-Assisted Programming Study" }}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="card-footer d-flex flex-wrap gap-2 justify-content-between">
                    <div>
                        {% if request.user.is_authenticated %}
                            {% if request.user.participantprofile.group == 'C' %}
                                <a href="{% url 'control_app:logout' %}" class="btn btn-danger">Log out</a>
                            {% else %}
                                <a href="{% url 'experimental_app:logout' %}" class="btn btn-danger">Log out</a>
                            {% endif %}
                        {% endif %}
                        <button type="button" class="btn btn-outline-light" id="closeTab">Close Tab</button>
                    </div>
                    <small class="text-muted align-self-center">Thank you again—we appreciate your time!</small>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Copy completion code
    (function () {
        const btn = document.getElementById('copyBtn');
        const input = document.getElementById('completionCode');
        if (!btn || !input) return;

        btn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(input.value);
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 1200);
            } catch {
                input.select();
                document.execCommand('copy');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 1200);
            }
        });
    })();

    // Close tab (may be blocked if not opened by script)
    document.getElementById('closeTab')?.addEventListener('click', () => {
        window.close();
    });

    // Gentle confetti
    (function confetti() {
        const root = document.getElementById('confetti');
        if (!root) return;
        const colors = ['#6cf', '#7dd3fc', '#a78bfa', '#3ddc97', '#f59e0b', '#ef4444'];
        const count = 24;
        for (let i = 0; i < count; i++) {
            const piece = document.createElement('i');
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.background = colors[Math.floor(Math.random() * colors.length)];
            piece.style.animationDuration = (6 + Math.random() * 5) + 's';
            piece.style.animationDelay = (Math.random() * 1.5) + 's';
            piece.style.opacity = 0.7 + Math.random() * 0.3;
            piece.style.transform = `translateY(-10px) rotate(${Math.random() * 360}deg)`;
            root.appendChild(piece);
        }
        // Clean up later (not critical on a terminal page)
        setTimeout(() => root.innerHTML = '', 15000);
    })();

    // Back-button guard: keep users from returning to earlier phases
    (function lockBack() {
        history.replaceState({lock: true}, '', location.href);
        history.pushState({lock: true}, '', location.href);
        window.addEventListener('popstate', function () {
            // Stay on thank-you (or optionally redirect to logout)
            location.replace(location.href);
        });
        // Avoid BFCache restore
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) location.reload();
        });
    })();
</script>
</body>
</html>
